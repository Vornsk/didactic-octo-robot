<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/locales/ko.js'></script>
</head>
<body>
    <style>
    body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
    }

    .container {
        width: 80%;
        margin: 0 auto;
        padding: 20px;
    }

    header {
        text-align: center;
        margin-bottom: 20px;
    }

    h1 {
        color: #333;
    }

    /* ë‹¬ë ¥ */
    #calendar {
        max-width: 100%;
        margin: 0 auto;
    }

    /* ëª¨ë‹¬ ì°½ */
    #taskModal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        width: 300px; /* ëª¨ë‹¬ ì¢Œìš°í­ ì„¤ì • */
        max-height: 90vh; /* ìµœëŒ€ ë†’ì´ ì„¤ì • */
        overflow: auto; /* ë‚´ìš©ì´ ë§ì„ ê²½ìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    }

    .modal-content {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 20px;
    }

    #taskModal h2 {
        margin-top: 0;
        margin-bottom: 20px;
        text-align: center; /* ì¤‘ì•™ ì •ë ¬ */
    }

    #tasksList {
        list-style-type: none;
        padding: 0;
        margin: 0;
        margin-bottom: 20px; /* ë¦¬ìŠ¤íŠ¸ì™€ ì…ë ¥ í¼ ì‚¬ì´ ì—¬ë°± */
    }

    #tasksList li {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: space-between; /* ë‚´ìš©ê³¼ ì‚­ì œ ë²„íŠ¼ ì‚¬ì´ì— ê³µê°„ì„ ë§Œë“­ë‹ˆë‹¤. */
    }

    #tasksList p {
        color: #888;
        margin: 0;
        cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•œ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½ */
        text-decoration: none; /* ë°‘ì¤„ ì‚­ì œ, í•„ìš”ì‹œ ì¶”ê°€í• ê²ƒ */
    }

    #tasksList p:hover {
        color: #dc3545; /* í´ë¦­ ì‹œ ìƒ‰ìƒ ë³€ê²½ */
    }

    #taskModal form {
        display: flex;
        flex-direction: column;
        margin-top: auto; /* í•˜ë‹¨ë¶€ì— ìœ„ì¹˜í•˜ë„ë¡ */
    }

    #taskModal input[type="text"] {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: calc(100% - 22px);
        margin-bottom: 10px;
    }

    #taskModal .button-container {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
    }

    #taskModal button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background-color: #b39ddb; /* íŒŒìŠ¤í…”í†¤ ë³´ë¼ìƒ‰ */
        color: #fff;
        cursor: pointer;
    }

    #taskModal button:hover {
        background-color: #9c27b0; /* ì–´ë‘ìš´ ë³´ë¼ìƒ‰ */
    }

    #closeModal {
        background-color: #dc3545;
    }

    #closeModal:hover {
        background-color: #c82333;
    }

    /* ì˜¤ë²„ë ˆì´ */
    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    .download-button {
        padding: 10px 20px;
        background-color: #4CAF50; /* ì´ˆë¡ìƒ‰ */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }

    .download-button:hover {
        background-color: #45a049; /* ì»¤ì„œ ì˜¬ë ¤ ë†“ì„ ì‹œ ì–´ë‘ìš´ ì´ˆë¡ìƒ‰ */
    }

    .weather-info {
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px;
        border-radius: 4px;
    }

    .weather-info .weather-icon {
        font-size: 18px;
        margin-right: 5px;
    }

    .weather-info .temp-max {
        color: red;
    }

    .weather-info .temp-min {
        color: blue;
    }

    .empty-task-message, .task-form-container {
        text-align: center; /* ì¤‘ì•™ ì •ë ¬ */
        margin-top: 20px; /* ìœ„ìª½ ì—¬ë°± ì¶”ê°€ */
    }

    .empty-task-message p {
        margin: 10px 0; /* ìœ„ìª½ê³¼ ì•„ë˜ìª½ ì—¬ë°± ì¶”ê°€ */
        color: #888;
    }
    </style>
<div class="container">
    <header>
        <h1>To-Do List</h1>
        <button class="download-button" onclick="downloadExcel()">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    </header>
    <div id="calendar"></div>

    <!-- ëª¨ë‹¬ ì°½ -->
    <div id="taskModal">
        <div class="modal-content">
            <h2>í•  ì¼ ì¶”ê°€ <span id="selectedDateText" style="font-size: 16px; margin-left: 10px;"></span></h2>
            <div id="tasksListContainer">
                <ul id="tasksList"></ul>
                <div class="empty-task-message">
                    <p id="noTasksMessage">ì´ ë‚ ì§œì—” í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
            <form id="taskForm">
                <div class="task-form-container">
                    <label for="task">í•  ì¼:</label>
                    <input type="text" id="task" name="task" required>
                </div>
                <input type="hidden" id="selectedDate" name="date">
                <div class="button-container">
                    <button type="submit">ì €ì¥</button>
                    <button type="button" id="closeModal">ë‹«ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <div id="overlay"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            dateClick: function(info) {
                var selectedDate = info.dateStr;
                $('#selectedDate').val(selectedDate);
                $('#selectedDateText').text(selectedDate);
                $('#overlay').show();
                $('#taskModal').show();
                loadTasks(selectedDate);
            },
            
        dayCellDidMount: function(info) {
            var formattedDate = formatDate(info.date);
            fetchWeatherInfo(formattedDate, function(weatherData) {
                console.log("ë°›ì€ ë‚ ì”¨ ë°ì´í„°:", weatherData);

                var weatherIcon = weatherData.weather || 'ğŸŒ¥';  // ê¸°ë³¸ ì•„ì´ì½˜
                var tempMax = weatherData.tempMax || '-';
                var tempMin = weatherData.tempMin || '-';

                var weatherHtml = `
                    <div class="weather-info">
                        <span class="weather-icon">${weatherIcon}</span>
                        <span class="temp-max">${tempMax}Â°C</span>
                        <span class="temp-min">${tempMin}Â°C</span>
                    </div>
                `;
                
                info.el.querySelector('.fc-daygrid-day-number').insertAdjacentHTML('afterend', weatherHtml);
            });

            function formatDate(date) {
                var d = new Date(date);  // JavaScript Date ê°ì²´ë¡œ ë³€í™˜
                var year = d.getFullYear();
                var month = ('0' + (d.getMonth() + 1)).slice(-2);  // ì›”ì„ 2ìë¦¬ë¡œ í¬ë§·
                var day = ('0' + d.getDate()).slice(-2);  // ì¼ì„ 2ìë¦¬ë¡œ í¬ë§·
                return `${year}-${month}-${day}`;
            }
        }
        });
        calendar.render();

        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                console.error("ì˜ëª»ëœ Date ê°ì²´:", date);
                return '';
            }
            
            var year = date.getFullYear();
            var month = ("0" + (date.getMonth() + 1)).slice(-2);
            var day = ("0" + date.getDate()).slice(-2);

            return `${year}-${month}-${day}`;
        }

        // ëª¨ë“  ë‚ ì§œì— ëŒ€í•œ ë‚ ì”¨ ì •ë³´ë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function fetchWeatherInfo(date, callback) {
            $.ajax({
                url: '/weather',
                type: 'GET',  // GET ìš”ì²­ìœ¼ë¡œ ë³€ê²½
                data: { date: date },  // ì¿¼ë¦¬ ë¬¸ìì—´ë¡œ ë‚ ì§œë¥¼ ì „ë‹¬
                success: function(data) {
                    callback(data);
                },
                error: function() {
                    console.log("Failed to fetch weather data.");
                    callback({});
                }
            });
        }


        $('#taskForm').on('submit', function (e) {
            e.preventDefault();
            var taskData = {
                date: $('#selectedDate').val(),
                task: $('#task').val()
            };

            $.post('/save_task', taskData, function(response) {
                alert(response.status);
                $('#overlay').hide();
                $('#taskModal').hide();
                $('#taskForm')[0].reset();
                loadTasks(taskData.date);
            }).fail(function() {
                alert('ì‘ì—… ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        });

        function loadTasks(date) {
                $.get('/get_tasks', { date: date }, function(tasks) {
                    $('#tasksList').empty();
                    if (tasks.length > 0) {
                        tasks.forEach(function(task, index) {
                            $('#tasksList').append(
                                '<li>' + 
                                    '<p data-index="' + index + '">' + task + '</p>' +
                                '</li>'
                            );
                        });
                        $('#noTasksMessage').hide(); // í•  ì¼ì´ ìˆì„ ë•Œ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                    } else {
                        $('#noTasksMessage').show(); // í•  ì¼ì´ ì—†ì„ ë•Œ ë©”ì‹œì§€ ë³´ì´ê¸°
                    }
                });
            }

        $('#tasksList').on('click', 'p', function() {
            var index = $(this).data('index');
            var date = $('#selectedDate').val();

            $.ajax({
                url: '/delete_task',
                method: 'POST',
                data: { date: date, index: index },
                success: function(response) {
                    alert(response.status);
                    loadTasks(date);
                },
                error: function() {
                    alert('í•  ì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

        $('#overlay').on('click', function() {
            $('#overlay').hide();
            $('#taskModal').hide();
        });

        $('#closeModal').on('click', function() {
            $('#overlay').hide();
            $('#taskModal').hide();
        });

        document.querySelector('.download-button').addEventListener('click', function() {
            var currentView = calendar.view;
            var taskMonth = currentView.currentStart.toISOString().substring(0, 7); // "YYYY-MM" í˜•ì‹
            downloadExcel(taskMonth);
        });

        function downloadExcel(taskMonth) {
            window.location.href = "/calendar/download_excel?task_month=" + taskMonth;
        }
    });
</script>
</body>
</html>